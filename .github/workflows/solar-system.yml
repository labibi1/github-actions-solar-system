# name: Solar System Workflow

# on: 
#   workflow_dispatch:
#   push:
#     branches:
#       - main
#       - 'feature/*'

# env:
#   MONGO_URI: 'mongodb+srv://supercluster.d83jj.mongodb.net/superData'
#   MONGO_USERNAME: superuser
#   MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
    
# jobs:
#   unit-testing:
#     name: Unit Testing
#     strategy:
#       matrix:
#         nodejs_version: [18, 20]
#         operating_system: [ubuntu-latest, macos-latest]
#         exclude:
#         - nodejs_version: 18
#           operating_system: macos-latest
#     runs-on: ${{ matrix.operating_system }}
#     steps:
#       - name: Checkout Repository
#         uses: actions/checkout@v4


#       - name: Setup Node.js ${{ matrix.nodejs_version }}
#         uses: actions/setup-node@v3
#         with:
#           node-version: ${{ matrix.nodejs_version }}


#       - name: Cache NPM dependencies
#         uses: actions/cache@v4
#         with:
#           path: node_modules
#           key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}


#       - name: Install Dependencies
#         run: npm install


#       - name: Run Unit Tests
#         run: npm test


#       - name: Archive Test Results
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: mocha-test-results1
#           path: test-results1.xml


#   code-coverage:
#     name: Code Coverage
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout Repository
#         uses: actions/checkout@v4


#       - name: Setup Node.js 18
#         uses: actions/setup-node@v3
#         with:
#           node-version: 18


#       - name: Cache NPM dependencies
#         uses: actions/cache@v4
#         with:
#           path: node_modules
#           key: ${{ runner.os }}-node-modules-${{ hashFiles('package-lock.json') }}


#       - name: Install Dependencies
#         run: npm install


#       - name: Run Coverage
#         continue-on-error: true
#         run: npm run coverage


#       - name: Archive Coverage Report
#         uses: actions/upload-artifact@v4
#         with:
#           name: coverage-report1
#           path: corvrage-results1.xml

name: Solar System CI/CD

on:
  # Allows manual triggering from the GitHub UI
  workflow_dispatch:
  push:
    branches:
      - main
      - 'feature/*' # Runs on main and any feature branch

env:
  # Using template variables for the URI structure, which is generally safer
  MONGO_HOST: supercluster.d83jj.mongodb.net
  MONGO_DBNAME: superData
  MONGO_USERNAME: superuser
  MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}

jobs:
  # ====================================================================
  # JOB 1: UNIT & INTEGRATION TESTING
  # ====================================================================
  unit-testing:
    name: Unit & Integration Tests (Node ${{ matrix.nodejs_version }}, ${{ matrix.operating_system }})
    strategy:
      matrix:
        nodejs_version: [18.x, 20.x]
        operating_system: [ubuntu-latest, macos-latest]
        exclude:
          # Exclude one combination to save CI time if it's redundant
          - nodejs_version: 18.x
            operating_system: macos-latest
    runs-on: ${{ matrix.operating_system }}
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js ${{ matrix.nodejs_version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.nodejs_version }}

      - name: üì¶ Cache NPM dependencies
        uses: actions/cache@v4
        id: npm-cache # Give the step an ID to check its status
        with:
          path: node_modules
          # Use hashFiles('**/package-lock.json') for robust path searching
          key: ${{ runner.os }}-${{ matrix.nodejs_version }}-node-modules-${{ hashFiles('**/package-lock.json') }}

      - name: Install Dependencies
        # Only run npm install if the cache was missed
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm install

      # FIX: The MONGO_URI needs to be explicitly defined for the test environment.
      # We construct the URI here. Note: Mongoose might expect a slightly different format
      # (e.g., including 'retryWrites=true&w=majority' or 'ssl=true').
      - name: Run Unit Tests
        run: |
          npm test
        env:
          # Use a different DB name (e.g., testData) if possible to isolate tests
          MONGO_URI: mongodb+srv://${{ env.MONGO_USERNAME }}:${{ env.MONGO_PASSWORD }}@${{ env.MONGO_HOST }}/${{ env.MONGO_DBNAME }}?authSource=admin&ssl=true

      - name: ‚¨ÜÔ∏è Archive Test Results
        if: always() # Archives even if tests fail
        uses: actions/upload-artifact@v4
        with:
          name: mocha-test-results-${{ matrix.operating_system }}-${{ matrix.nodejs_version }}
          path: test-results1.xml # Check that your Mocha reporter output this exact file name

  # ====================================================================
  # JOB 2: CODE COVERAGE
  # ====================================================================
  code-coverage:
    name: Code Coverage
    # Ensure this job only runs after tests pass
    needs: unit-testing
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18.x

      - name: üì¶ Cache NPM dependencies
        uses: actions/cache@v4
        id: npm-cache-coverage
        with:
          path: node_modules
          key: ${{ runner.os }}-18.x-node-modules-${{ hashFiles('**/package-lock.json') }}

      - name: Install Dependencies
        if: steps.npm-cache-coverage.outputs.cache-hit != 'true'
        run: npm install

      - name: Run Coverage
        # If npm run coverage fails (e.g., due to low threshold), continue-on-error prevents blocking the artifact step
        continue-on-error: true
        run: npm run coverage

      - name: ‚¨ÜÔ∏è Archive Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          # FIX: Corrected the typo in the file name from 'corvrage-results1.xml'
          path: coverage-results1.xml