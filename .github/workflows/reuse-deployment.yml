# .github/workflows/reuse-deployment.yml
name: Deployment â€“ Reusable Workflow


on:
  workflow_call:
    # inputs:
    #   kubeconfig:
    #     description: 'Kubernetes config for the target cluster'
    #     required: true
    #     type: string
    secrets:
      k8s-kubeconfig:
        required: true
      mongodb-password:
        required: true


jobs:
  reuse-dev-deploy:
   environment:
      name: development
      url: https://${{ steps.set-ingress-host-address.outputs.APP_INGRESS_HOST }}
   outputs:
      APP_INGRESS_URL: ${{ steps.set-ingress-host-address.outputs.APP_INGRESS_HOST }}
   runs-on: ubuntu-latest
   
   steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install kubectl CLI
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.26.0'

    - name: Configure kubeconfig context
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.k8s-kubeconfig }}

    - name: Fetch Kubernetes cluster details
      run: |
        kubectl version 
        echo '---------------------------------'
        kubectl get nodes

    - name: Save Nginx Ingress IP
      id: ingress
      run: |
          echo "INGRESS_IP=$(kubectl -n ingress-nginx get svc ingress-nginx-controller \
            -o jsonpath='{.status.loadBalancer.ingress[0].ip}')" >> $GITHUB_ENV

    - name: Replace tokens in manifests
      uses: cschleiden/replace-tokens@v1
      with:
        tokenPrefix: '_{_'
        tokenSuffix: '_}_'
        files: kubernetes/development/*.yaml
      env:
        NAMESPACE: ${{ vars.NAMESPACE }}
        REPLICAS: ${{ vars.REPLICAS }}
        IMAGE: ${{ vars.DOCKERHUB_USERNAME }}/solar-system:${{ github.sha }}
        INGRESS_IP: ${{ env.INGRESS_IP }}

    - name: Verify replaced manifests
      run: cat kubernetes/development/*.yaml

    - name: Create MongoDB Secret and Namespace (Conditionally)
      run: |
          if ! kubectl get namespace ${{ vars.NAMESPACE }} &> /dev/null; then
              echo "Namespace ${{ vars.NAMESPACE }} not found. Creating it now..."
              kubectl create namespace ${{ vars.NAMESPACE }}
          else
              echo "Namespace ${{ vars.NAMESPACE }} already exists. Skipping creation."
          fi
          kubectl -n ${{ vars.NAMESPACE }} create secret generic mongo-db-creds \
            --from-literal=MONGO_URI=${{ env.MONGO_URI }} \
            --from-literal=MONGO_USERNAME=${{ env.MONGO_USERNAME }} \
            --from-literal=MONGO_PASSWORD=${{ secrets.mongodb-password }} \
            --save-config \
            --dry-run=client \
            -o yaml | kubectl apply -f -

    - name: Deploy to Dev Environment
      run: |
          kubectl apply -f kubernetes/development

    - name: Set App Ingress Host URL
      id: set-ingress-host-address
      run: |
          # **CORRECTION APPLIED HERE:**
          # Using spec.rules[0].host is more robust for finding the Hostname
          # compared to spec.tls[0].hosts[0] which requires a TLS configuration.
          HOST=$(kubectl -n ${{ vars.NAMESPACE }} \
            get ingress -o jsonpath='{.items[0].spec.rules[0].host}')
          
          echo "Captured HOST value: $HOST"
          echo "APP_INGRESS_HOST=$HOST" >> "$GITHUB_OUTPUT" # Note: using APP_INGRESS_HOST as defined in outputs

  # reuse-prod-deploy:
  #     environment:
  #       name: prod
  #       # The 'url' link here will also correctly use the captured HOST value.
  #       url: https://${{ steps.set-ingress-host-address.outputs.APP_INGRESS_HOST }}
  #     outputs:
  #       # We map the step output to the job output
  #       APP_INGRESS_URL: ${{ steps.set-ingress-host-address.outputs.APP_INGRESS_HOST }}
  #     runs-on: ubuntu-latest
  #     steps:
  #     - name: Checkout Repo
  #       uses: actions/checkout@v4

  #     - name: Install kubectl CLI
  #       uses: azure/setup-kubectl@v3
  #       with:
  #         version: 'v1.26.0'

  #     - name: Configure kubeconfig context
  #       uses: azure/k8s-set-context@v3
  #       with:
  #         method: kubeconfig
  #         kubeconfig: ${{ secrets.k8s-kubeconfig }}

  #     - name: Fetch Kubernetes cluster details
  #       run: |
  #         kubectl version 
  #         echo '---------------------------------'
  #         kubectl get nodes

  #     - name: Save Nginx Ingress IP
  #       run: |
  #         echo "INGRESS_IP=$(kubectl -n ingress-nginx get svc ingress-nginx-controller \
  #           -o jsonpath='{.status.loadBalancer.ingress[0].ip}')" >> $GITHUB_ENV


  #     - name: Replace tokens in manifests
  #       uses: cschleiden/replace-tokens@v1
  #       with:
  #         tokenPrefix: '_{_'
  #         tokenSuffix: '_}_'
  #         files: kubernetes/production/*.yaml
  #       env:
  #         NAMESPACE: ${{ vars.NAMESPACE }}
  #         REPLICAS: ${{ vars.REPLICAS }}
  #         IMAGE: ${{ vars.DOCKERHUB_USERNAME }}/solar-system:${{ github.sha }}
  #         INGRESS_IP: ${{ env.INGRESS_IP }}


  #     - name: Review Production Manifests
  #       run: cat kubernetes/production/*.yaml


  #     - name: Create MongoDB Secret and Namespace (Conditionally)
  #       run: |
  #         if ! kubectl get namespace ${{ vars.NAMESPACE }} &> /dev/null; then
  #             echo "Namespace ${{ vars.NAMESPACE }} not found. Creating it now..."
  #             kubectl create namespace ${{ vars.NAMESPACE }}
  #         else
  #             echo "Namespace ${{ vars.NAMESPACE }} already exists. Skipping creation."
  #         fi
  #         kubectl -n ${{ vars.NAMESPACE }} create secret generic mongo-db-creds \
  #           --from-literal=MONGO_URI=${{ env.MONGO_URI }} \
  #           --from-literal=MONGO_USERNAME=${{ env.MONGO_USERNAME }} \
  #           --from-literal=MONGO_PASSWORD=${{ secrets.mongodb-password }} \
  #           --save-config \
  #           --dry-run=client \
  #           -o yaml | kubectl apply -f -

  #     - name: Deploy to Production
  #       run: kubectl apply -f kubernetes/production


  #     - name: Set App Ingress Host URL
  #       id: set-ingress-host-address
  #       run: |
  #         # **CORRECTION APPLIED HERE:**
  #         # Using spec.rules[0].host is more robust for finding the Hostname
  #         # compared to spec.tls[0].hosts[0] which requires a TLS configuration.
  #         HOST=$(kubectl -n ${{ vars.NAMESPACE }} \
  #           get ingress -o jsonpath='{.items[0].spec.rules[0].host}')
          
  #         echo "Captured HOST value: $HOST"
  #         echo "APP_INGRESS_HOST=$HOST" >> "$GITHUB_OUTPUT" # Note: using APP_INGRESS_HOST as defined in outputs